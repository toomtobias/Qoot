<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz - Spela</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#6366f1',
            'primary-hover': '#4f46e5',
          }
        }
      }
    }
  </script>
  <style>
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner { animation: spin 1s linear infinite; }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen flex flex-col items-center justify-center p-4 transition-colors">
  <button class="absolute top-4 right-4 bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-2 rounded-lg transition-colors" id="dark-mode-toggle" title="V√§xla mellan light och dark mode">
    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
      <!-- Sun icon (visible in light mode) -->
      <circle class="sun-icon" cx="10" cy="10" r="5" opacity="1" style="transition: opacity 0.3s;"/>
      <!-- Moon icon (visible in dark mode) -->
      <path class="moon-icon" d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" opacity="0" style="transition: opacity 0.3s;"/>
    </svg>
  </button>
  <div class="w-full max-w-lg">
    <!-- Join View -->
    <div id="join-view" class="view">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 text-center">
        <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-6">G√• med i quiz</h1>
        <form id="join-form">
          <div class="mb-4">
            <input
              type="text"
              id="player-name"
              class="w-full px-4 py-4 text-lg text-center border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white rounded-xl focus:border-primary focus:outline-none transition-colors"
              placeholder="Ditt namn"
              maxlength="20"
              required
              autofocus
            >
          </div>
          <button type="submit" class="w-full bg-primary hover:bg-primary-hover text-white font-semibold py-4 px-6 rounded-xl transition-colors text-lg">
            G√• med
          </button>
        </form>
      </div>
    </div>

    <!-- Lobby View -->
    <div id="lobby-view" class="view hidden">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 text-center">
        <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-6" id="quiz-name-player">-</h2>
        <p class="text-primary text-sm font-medium mb-6">V√§ntar p√• start...</p>

        <img id="player-avatar" src="" alt="Avatar" class="w-20 h-20 rounded-full mx-auto mb-4">
        <p class="text-gray-500 dark:text-gray-400 mb-6">Du √§r med som: <strong class="text-gray-800 dark:text-gray-200" id="display-name">-</strong></p>

        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">Spelare i lobbyn:</h3>
        <ul id="player-list" class="space-y-2 text-left"></ul>
      </div>
    </div>

    <!-- Question View -->
    <div id="question-view" class="view hidden">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6">
        <div class="flex items-center justify-between mb-4">
          <span class="text-gray-500 dark:text-gray-400">Fr√•ga <span id="q-number">1</span> av <span id="q-total">5</span></span>
          <span class="bg-amber-100 dark:bg-amber-900 text-amber-700 dark:text-amber-200 font-bold text-2xl px-4 py-2 rounded-xl" id="timer">30</span>
        </div>

        <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-6 text-center" id="question-text">-</h2>

        <div class="grid grid-cols-1 gap-3" id="options-player"></div>

        <p class="text-gray-500 dark:text-gray-400 text-center mt-6">
          <span id="answer-count-player">0</span> av <span id="total-players-player">0</span> spelare har besvarat
        </p>
      </div>
    </div>

    <!-- Results View -->
    <div id="results-view" class="view hidden">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 text-center">
        <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-2" id="result-title">-</h2>
        <p class="text-gray-500 dark:text-gray-400 mb-4">R√§tt svar: <strong class="text-gray-800 dark:text-gray-200" id="correct-answer">-</strong></p>

        <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6 mb-6">
          <span class="block text-4xl font-bold text-gray-800 dark:text-white mb-2" id="points-earned">+0</span>
          <span class="text-gray-500 dark:text-gray-400">Total: <span id="your-total" class="font-semibold text-gray-800 dark:text-gray-200">0</span> po√§ng</span>
        </div>

        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">St√§llning</h3>
        <ol id="standings" class="space-y-2 text-left mb-4"></ol>

        <p class="text-gray-500 dark:text-gray-400 text-sm">N√§sta fr√•ga om <span class="font-bold text-primary" id="countdown-player">5</span> sekund<span id="countdown-plural-player">er</span>...</p>
      </div>
    </div>

    <!-- Podium View -->
    <div id="podium-view" class="view hidden">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 text-center">
        <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-8">Quiz avslutat!</h1>

        <div id="podium" class="flex justify-center items-end gap-3 mb-8"></div>

        <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6 mb-6">
          <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Din placering</h3>
          <p class="text-4xl font-bold text-primary mb-1">#<span id="your-position">-</span></p>
          <p class="text-gray-500 dark:text-gray-400 mb-3"><span id="your-final-score" class="font-semibold text-gray-800 dark:text-gray-200">0</span> po√§ng</p>
          <p class="text-gray-500 dark:text-gray-400 text-sm"><span id="your-correct-answers" class="font-semibold text-gray-800 dark:text-gray-200">0</span> av <span id="your-total-questions" class="font-semibold text-gray-800 dark:text-gray-200">0</span> korrekta svar</p>
        </div>

        <a href="/" class="inline-block w-full bg-primary hover:bg-primary-hover text-white font-semibold py-4 px-6 rounded-xl transition-colors text-lg">
          Spela igen
        </a>
      </div>
    </div>

    <!-- Error View -->
    <div id="error-view" class="view hidden">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 text-center border-2 border-red-200 dark:border-red-900">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">N√•got gick fel</h2>
        <p class="text-gray-500 dark:text-gray-400 mb-6" id="error-message">Sessionen hittades inte.</p>
        <a href="/" class="inline-block w-full bg-primary hover:bg-primary-hover text-white font-semibold py-4 px-6 rounded-xl transition-colors">
          Tillbaka till start
        </a>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const getApiUrl = () => {
      return window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
        ? 'http://localhost:3000'
        : 'https://qoot.up.railway.app';
    };

    const sessionId = window.location.pathname.split('/').pop();
    let socket;
    let playerName = '';
    let selectedAnswer = null;
    let myScore = 0;
    let isConnected = false;
    let lastBeepTime = 0;

    // Simple beep function using Web Audio API
    function playBeep() {
      const now = Date.now();
      // Only play beep if at least 100ms has passed since last beep
      if (now - lastBeepTime < 100) return;
      lastBeepTime = now;

      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.value = 800; // Hz
        oscillator.type = 'sine';

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.1);
      } catch (e) {
        // Audio context not supported or user denied permission
      }
    }

    // End sound when time is up
    function playEndSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.value = 1200; // Hz (higher pitch)
        oscillator.type = 'sine';

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
      } catch (e) {
        // Audio context not supported or user denied permission
      }
    }

    // Dark mode toggle
    function initDarkMode() {
      const toggle = document.getElementById('dark-mode-toggle');
      const sunIcon = document.querySelector('.sun-icon');
      const moonIcon = document.querySelector('.moon-icon');

      // Load preference from localStorage
      const isDark = localStorage.getItem('dark-mode') === 'true';
      if (isDark) {
        document.documentElement.classList.add('dark');
        sunIcon.style.opacity = '0';
        moonIcon.style.opacity = '1';
      }

      toggle.addEventListener('click', () => {
        const isDarkMode = document.documentElement.classList.toggle('dark');
        localStorage.setItem('dark-mode', isDarkMode);

        // Animate icons
        sunIcon.style.opacity = isDarkMode ? '0' : '1';
        moonIcon.style.opacity = isDarkMode ? '1' : '0';
      });
    }

    const views = {
      join: document.getElementById('join-view'),
      lobby: document.getElementById('lobby-view'),
      question: document.getElementById('question-view'),
      results: document.getElementById('results-view'),
      podium: document.getElementById('podium-view'),
      error: document.getElementById('error-view')
    };

    function showView(viewName) {
      Object.values(views).forEach(v => v.classList.add('hidden'));
      views[viewName].classList.remove('hidden');
    }

    async function checkSession() {
      try {
        const response = await fetch(`${getApiUrl()}/api/session/${sessionId}`);
        if (!response.ok) {
          document.getElementById('error-message').textContent = 'Sessionen hittades inte.';
          showView('error');
          return false;
        }
        const data = await response.json();
        if (data.status !== 'lobby') {
          document.getElementById('error-message').textContent = 'Quizet har redan startat.';
          showView('error');
          return false;
        }
        return true;
      } catch (error) {
        document.getElementById('error-message').textContent = 'Kunde inte ansluta till servern.';
        showView('error');
        return false;
      }
    }

    function connect() {
      const socketUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
        ? 'http://localhost:3000'
        : 'https://qoot.up.railway.app';
      socket = io(socketUrl);

      socket.on('connect', () => {
        // Only join if this is the first connection, otherwise just reconnect silently
        if (!isConnected) {
          socket.emit('player:join', { sessionId, playerName });
        }
      });

      socket.on('lobby:players', (data) => {
        isConnected = true;
        const players = Array.isArray(data) ? data : data.players;
        const quizName = data.quizName || 'Quiz';

        document.getElementById('quiz-name-player').textContent = quizName;
        updatePlayerList(players);

        const me = players.find(p => p.name === playerName);
        if (me) myScore = me.score;
      });

      socket.on('quiz:question', (data) => {
        selectedAnswer = null;
        showQuestion(data);
        showView('question');
      });

      socket.on('host:answerCount', (data) => {
        document.getElementById('answer-count-player').textContent = data.answered;
        document.getElementById('total-players-player').textContent = data.total;
      });

      socket.on('quiz:timer', (data) => {
        const timer = document.getElementById('timer');
        timer.textContent = data.timeLeft;
        if (data.timeLeft <= 5) {
          timer.classList.remove('bg-amber-100', 'text-amber-700');
          timer.classList.add('bg-red-100', 'text-red-700');
          if (data.timeLeft > 0) {
            playBeep();
          } else if (data.timeLeft === 0) {
            playEndSound();
          }
        }
      });

      socket.on('quiz:results', (data) => {
        showResults(data);
        showView('results');
      });

      socket.on('quiz:countdown', (data) => {
        const countdownText = data.isLastQuestion ? 'Slutresultat om' : 'N√§sta fr√•ga om';
        document.querySelector('#results-view p:last-of-type').innerHTML = `${countdownText} <span class="font-bold text-primary" id="countdown-player">${data.timeLeft}</span> sekund<span id="countdown-plural-player">${data.timeLeft === 1 ? '' : 'er'}</span>...`;
      });

      socket.on('quiz:finished', (data) => {
        showPodium(data);
        showView('podium');
      });

      socket.on('session:ended', (data) => {
        document.getElementById('error-message').textContent = data.reason;
        showView('error');
      });

      socket.on('error', (data) => {
        // Only show error on first connection attempt, not on reconnect
        if (!isConnected) {
          document.getElementById('error-message').textContent = data.message;
          showView('error');
        }
        // On reconnect during active game, just silently reconnect without showing error
      });

      socket.on('disconnect', () => {
        console.log('[Socket] Disconnected - will attempt automatic reconnect');
      });
    }

    function updatePlayerList(players) {
      document.getElementById('player-list').innerHTML = players.map(p => `
        <li class="flex items-center justify-between px-4 py-3 rounded-lg ${p.name === playerName ? 'bg-primary/10 dark:bg-primary/20 ring-2 ring-primary' : 'bg-gray-50 dark:bg-gray-700'}">
          <div class="flex items-center gap-3">
            <img src="https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(p.name)}" alt="${escapeHtml(p.name)}" class="w-8 h-8 rounded-full">
            <span class="font-medium text-gray-800 dark:text-gray-200">${escapeHtml(p.name)}</span>
          </div>
          <span class="text-gray-500 dark:text-gray-400">${p.score} po√§ng</span>
        </li>
      `).join('');
    }

    function showQuestion(data) {
      document.getElementById('q-number').textContent = data.questionNumber;
      document.getElementById('q-total').textContent = data.totalQuestions;
      document.getElementById('answer-count-player').textContent = '0';
      document.getElementById('total-players-player').textContent = data.totalPlayers || 0;
      const timer = document.getElementById('timer');
      timer.textContent = data.timeLimit;
      timer.classList.remove('bg-red-100', 'text-red-700');
      timer.classList.add('bg-amber-100', 'text-amber-700');
      document.getElementById('question-text').textContent = data.question;

      document.getElementById('options-player').innerHTML = data.options.map((opt, i) => `
        <button class="option-btn flex items-center gap-4 w-full p-4 bg-gray-50 hover:bg-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 border-2 border-gray-200 dark:border-gray-600 rounded-xl text-left transition-all" data-index="${i}">
          <span class="w-10 h-10 bg-gray-200 dark:bg-gray-600 rounded-full flex items-center justify-center font-bold text-gray-600 dark:text-gray-300 flex-shrink-0">${['A', 'B', 'C', 'D'][i]}</span>
          <span class="text-gray-800 dark:text-gray-200 font-medium">${escapeHtml(opt)}</span>
        </button>
      `).join('');

      document.querySelectorAll('.option-btn').forEach(btn => {
        btn.addEventListener('click', () => selectAnswer(parseInt(btn.dataset.index)));
      });
    }

    function selectAnswer(index) {
      selectedAnswer = index;
      document.querySelectorAll('.option-btn').forEach((btn, i) => {
        if (i === index) {
          // Remove hover effect and unselected styles
          btn.classList.remove('bg-gray-50', 'border-gray-200', 'hover:bg-gray-100');
          // Add selected styles with !important background
          btn.classList.add('!bg-primary', 'border-primary', 'text-white');
          btn.querySelector('span:first-child').classList.remove('bg-gray-200', 'text-gray-600');
          btn.querySelector('span:first-child').classList.add('bg-white', 'text-primary');
          btn.querySelector('span:last-child').classList.remove('text-gray-800');
          btn.querySelector('span:last-child').classList.add('text-white');
        } else {
          // Restore hover effect and unselected styles
          btn.classList.add('bg-gray-50', 'border-gray-200', 'hover:bg-gray-100');
          btn.classList.remove('!bg-primary', 'border-primary', 'text-white');
          btn.querySelector('span:first-child').classList.add('bg-gray-200', 'text-gray-600');
          btn.querySelector('span:first-child').classList.remove('bg-white', 'text-primary');
          btn.querySelector('span:last-child').classList.add('text-gray-800');
          btn.querySelector('span:last-child').classList.remove('text-white');
        }
      });
      socket.emit('player:answer', index);
    }

    function showResults(data) {
      const myResult = data.playerResults.find(p => p.name === playerName);

      if (myResult) {
        myScore = myResult.totalScore;
        const isCorrect = myResult.isCorrect;
        const resultTitle = document.getElementById('result-title');
        resultTitle.textContent = isCorrect ? '‚úÖ R√§tt!' : '‚ùå Fel!';
        resultTitle.className = `text-3xl font-bold mb-2 text-gray-800 dark:text-white`;

        const pointsEl = document.getElementById('points-earned');
        pointsEl.textContent = `+${myResult.pointsEarned}`;
        pointsEl.className = `block text-4xl font-bold mb-2 ${isCorrect ? 'text-green-600 dark:text-green-400' : 'text-gray-400 dark:text-gray-500'}`;

        document.getElementById('your-total').textContent = myScore;
      }

      document.getElementById('correct-answer').textContent = data.correctAnswer;

      document.getElementById('standings').innerHTML = data.playerResults.map((p, i) => `
        <li class="flex items-center gap-3 px-4 py-3 rounded-lg ${p.name === playerName ? 'bg-primary/10 dark:bg-primary/20 ring-2 ring-primary' : 'bg-gray-50 dark:bg-gray-700'}">
          <span class="font-bold text-gray-400 dark:text-gray-500 w-6">${i + 1}.</span>
          <img src="https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(p.name)}" alt="${escapeHtml(p.name)}" class="w-6 h-6 rounded-full">
          <span class="flex-1 font-medium text-gray-800 dark:text-gray-200">
            ${escapeHtml(p.name)}
            ${p.streak > 1 ? `<span class="ml-2">üî•${p.streak}</span>` : ''}
          </span>
          <span class="font-bold ${p.isCorrect ? 'text-green-600 dark:text-green-400' : 'text-gray-400 dark:text-gray-500'}">+${p.pointsEarned}</span>
          <span class="text-gray-500 dark:text-gray-400">${p.totalScore} po√§ng</span>
        </li>
      `).join('');
    }

    function showPodium(data) {
      const podiumColors = ['', 'from-yellow-400 to-amber-500', 'from-gray-300 to-gray-400', 'from-orange-400 to-orange-600'];
      const podiumOrder = [2, 1, 3];

      document.getElementById('podium').innerHTML = podiumOrder.map(pos => {
        const p = data.podium.find(x => x.position === pos);
        if (!p) return '';
        const height = pos === 1 ? 'pb-10' : pos === 2 ? 'pb-6' : 'pb-2';
        const isMe = p.name === playerName;
        return `
          <div class="text-center bg-gradient-to-b ${podiumColors[pos]} text-white rounded-xl px-4 py-3 ${height} min-w-[80px]">
            <div class="text-2xl mb-1">${['', 'ü•á', 'ü•à', 'ü•â'][pos]}</div>
            <img src="https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(p.name)}" alt="${escapeHtml(p.name)}" class="w-10 h-10 rounded-full mx-auto mb-1">
            <div class="font-bold text-sm">${escapeHtml(p.name)}</div>
            <div class="text-xs opacity-80">${p.score}</div>
          </div>
        `;
      }).join('');

      const myPosition = data.allResults.findIndex(p => p.name === playerName) + 1;
      const myResult = data.allResults.find(p => p.name === playerName);
      const myFinalScore = myResult?.score || 0;
      const myCorrectAnswers = myResult?.correctAnswers || 0;
      const totalQuestions = myResult?.totalQuestions || 0;

      document.getElementById('your-position').textContent = myPosition;
      document.getElementById('your-final-score').textContent = myFinalScore;
      document.getElementById('your-correct-answers').textContent = myCorrectAnswers;
      document.getElementById('your-total-questions').textContent = totalQuestions;
    }

    // Initialize dark mode
    initDarkMode();

    document.getElementById('join-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      playerName = document.getElementById('player-name').value.trim();
      if (!playerName) return;

      const sessionValid = await checkSession();
      if (!sessionValid) return;

      document.getElementById('display-name').textContent = playerName;
      document.getElementById('player-avatar').src = `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(playerName)}`;

      connect();
      showView('lobby');
    });

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
